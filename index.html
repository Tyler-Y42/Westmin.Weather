<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Westmin Weather</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            padding: 12px;
        }
        .container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: 1.1fr 1.1fr 2.48fr 0.54fr 0.36fr auto;
            gap: 10px;
        }
        
        /* Rows 1 & 2: Cards remain 3-column layout */
        .temp-main { grid-column: 1 / 3; }
        .forecast-card { grid-column: 3 / 5; }
        .wind-card { grid-column: 5 / 7; }
        .aqi-card { grid-column: 1 / 3; }
        .precip-card { grid-column: 3 / 5; }
        .pressure-card { grid-column: 5 / 7; }
        
        /* Row 3: BOTH forecast charts side by side, EXACTLY 50/50 */
        .forecast-graph-card { 
            grid-column: 1 / 4; 
            grid-row: 3; 
        }
        .week-forecast-card { 
            grid-column: 4 / 7; 
            grid-row: 3; 
        }
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        /* Current Temp Card */
        .temp-main { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 5px; padding-bottom: 0px; position: relative; }
        .temp-ring-container { position: relative; display: flex; align-items: center; justify-content: center; }
        .temp-ring-svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .temp-current { font-size: clamp(3.75rem, 3.2vw, 3.825rem); font-weight: 200; color: #fff; line-height: 1; position: relative; z-index: 1; }
        .temp-current a { color: #fff; text-decoration: none; }
        .temp-current a:hover { color: #74ebd5; }
        .temp-current .unit { font-size: clamp(1.25rem, 1.15vw, 1.36rem); vertical-align: super; color: #74ebd5; }
        .temp-label { font-size: clamp(0.94rem, 0.75vw, 0.8925rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 2px; margin-top: 4px; }
        
        /* Today's Forecast Card */
        .forecast-card { display: flex; flex-direction: column; justify-content: center; gap: 4.5px; padding: 9.1px 9.1px 9.1px 9.1px; padding-top: 13.3px; padding-bottom: 13.3px; }
        .forecast-card .card-title { font-size: clamp(0.76rem, 0.62vw, 0.75rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; text-align: center; margin-bottom: 2px; }
        .forecast-item { display: flex; align-items: center; justify-content: space-between; }
        .forecast-item .label { font-size: clamp(0.93rem, 0.82vw, 0.96rem); color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 1px; }
        .forecast-item .value { font-size: clamp(1.76rem, 1.49vw, 1.79rem); font-weight: 300; }
        .forecast-item.high .value { color: #ff6b6b; }
        .forecast-item.low .value { color: #4ecdc4; }
        
        /* Wind Card */
        .wind-card { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2.0px; padding-top: 5px; padding-bottom: 5px; }
        .wind-speed { font-size: clamp(2.16rem, 1.8vw, 2.13rem); font-weight: 200; color: #fff; }
        .wind-speed .unit { font-size: clamp(0.83rem, 0.73vw, 0.86rem); color: #74ebd5; }
        .wind-direction { display: flex; align-items: center; gap: 4.0px; }
        .wind-arrow { width: clamp(25px, 1.96vw, 24px); height: clamp(25px, 1.96vw, 24px); border: 2px solid #74ebd5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: clamp(0.83rem, 0.73vw, 0.86rem); transition: transform 0.5s ease; }
        .wind-dir-text { font-size: clamp(0.83rem, 0.73vw, 0.86rem); color: #74ebd5; font-weight: 500; }
        .wind-gust { font-size: clamp(0.74rem, 0.62vw, 0.73rem); color: rgba(255, 255, 255, 0.5); }
        .wind-gust span { color: #ff9f43; }
        
        /* AQI Card */
        .aqi-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4.5px; padding-top: 5px; padding-bottom: 5px; }
        .aqi-value { font-size: clamp(3.07rem, 2.63vw, 3.14rem); font-weight: 200; }
        .aqi-label { font-size: clamp(0.93rem, 0.82vw, 0.96rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 2px; }
        .aqi-status { font-size: clamp(0.77rem, 0.62vw, 0.82rem); font-weight: 500; padding: 5px 10px; border-radius: 20px; }
        .aqi-good { background: #27ae60; color: #fff; }
        .aqi-moderate { background: #f1c40f; color: #333; }
        .aqi-sensitive { background: #e67e22; color: #fff; }
        .aqi-unhealthy { background: #e74c3c; color: #fff; }
        .aqi-very-unhealthy { background: #8e44ad; color: #fff; }
        .aqi-hazardous { background: #7b241c; color: #fff; }
        
        /* Precip Card */
        .precip-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5.1px; padding-top: 5px; padding-bottom: 5px; }
        .precip-value { font-size: clamp(3.5rem, 3vw, 3.57rem); font-weight: 200; color: #74b9ff; }
        .precip-label { font-size: clamp(1.06rem, 0.93vw, 1.105rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Pressure Card */
        .pressure-card { display: flex; flex-direction: column; padding-top: 5px; padding-bottom: 5px; }
        .pressure-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.55px; }
        .pressure-value { font-size: clamp(1.25rem, 1.07vw, 1.275rem); font-weight: 200; color: #74ebd5; }
        .pressure-value .unit { font-size: clamp(0.75rem, 0.61vw, 0.7225rem); color: rgba(255, 255, 255, 0.5); }
        .pressure-label { font-size: clamp(0.75rem, 0.61vw, 0.7225rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; }
        .pressure-trend { font-size: clamp(0.875rem, 0.71vw, 0.85rem); }
        .trend-up { color: #27ae60; }
        .trend-down { color: #e74c3c; }
        .trend-stable { color: rgba(255, 255, 255, 0.5); }
        .pressure-chart-container { flex: 1; position: relative; min-height: 0; }
        
        /* Forecast Graph */
        .forecast-graph-card { display: flex; flex-direction: column; }
        .forecast-graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .forecast-graph-title { font-size: 1.6rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; }
        .chart-container { flex: 1; position: relative; min-height: 0; }
        canvas { width: 100% !important; height: 100% !important; }
        
        /* 7-Day Forecast Card */
        .week-forecast-card { display: flex; flex-direction: column; padding: 14px; }
        .week-chart-container { flex: 1; position: relative; min-height: 0; }
        
        /* Extra Data Row */
        .extra-data { grid-column: 1 / -1; display: flex; justify-content: space-around; align-items: center; padding: 4px; }
        .extra-item { text-align: center; }
        .extra-item .value { font-size: clamp(1.25rem, 1.12vw, 1.344rem); color: #fff; }
        .extra-item .label { font-size: clamp(0.81rem, 0.70vw, 0.84rem); color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        
        /* Footer */
        .short-forecast { grid-column: 1 / -1; text-align: center; padding: 8px; font-size: clamp(1.19rem, 1.05vw, 1.26rem); color: rgba(255, 255, 255, 0.7); font-style: italic; }
        .update-footer { grid-column: 1 / -1; text-align: center; font-size: clamp(1.19rem, 1.05vw, 1.26rem); color: rgba(255, 255, 255, 0.3); padding: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Row 1 -->
        <div class="card temp-main">
            <div class="temp-ring-container">
                <svg class="temp-ring-svg" width="200" height="160" viewBox="0 0 200 160">
                    <circle id="temp-ring" cx="100" cy="90" r="65" fill="none" stroke="#ffffff" stroke-width="9" opacity="0.8"/>
                </svg>
                <div class="temp-current"><a id="temp-link" href="#" target="_blank"><span id="temp-now">--</span><span class="unit">°F</span></a></div>
            </div>
            <div class="temp-label" id="temp-label">Current</div>
        </div>
        <div class="card forecast-card">
            <div class="card-title">Today's Forecast</div>
            <div class="forecast-item high"><span class="label">High</span><span class="value"><span id="forecast-high">--</span>°</span></div>
            <div class="forecast-item low"><span class="label">Low</span><span class="value"><span id="forecast-low">--</span>°</span></div>
        </div>
        <div class="card wind-card">
            <div class="wind-speed"><span id="wind-speed">--</span> <span class="unit">mph</span></div>
            <div class="wind-direction">
                <div class="wind-arrow" id="wind-arrow">↑</div>
                <span class="wind-dir-text" id="wind-dir">--</span>
            </div>
            <div class="wind-gust">Gusts: <span id="wind-gust">--</span> mph</div>
        </div>
        
        <!-- Row 2 -->
        <div class="card aqi-card">
            <div class="aqi-value" id="aqi-value">--</div>
            <div class="aqi-label">AQI</div>
            <div class="aqi-status" id="aqi-status">Loading</div>
        </div>
        <div class="card precip-card">
            <div class="precip-value"><span id="precip-chance">--</span>%</div>
            <div class="precip-label">Chance of Precip</div>
        </div>
        <div class="card pressure-card">
            <div class="pressure-header">
                <div>
                    <div class="pressure-value"><span id="pressure-now">--</span> <span class="unit">inHg</span> <span class="pressure-trend" id="pressure-trend">--</span></div>
                    <div class="pressure-label">Pressure (24hr)</div>
                </div>
            </div>
            <div class="pressure-chart-container"><canvas id="pressure-chart"></canvas></div>
        </div>
        
        <!-- Row 3: 12hr Forecast Graph -->
        <div class="card forecast-graph-card">
            <div class="forecast-graph-header">
                <span class="forecast-graph-title">12-Hour Forecast</span>
            </div>
            <div class="chart-container"><canvas id="forecast-chart"></canvas></div>
        </div>
        
        <!-- Row 3: 7-Day Forecast -->
        <div class="card week-forecast-card">
            <div class="forecast-graph-header">
                <span class="forecast-graph-title">7-Day Forecast</span>
            </div>
            <div class="week-chart-container"><canvas id="week-chart"></canvas></div>
        </div>
        
        <!-- Row 4: Extra data -->
        <div class="card extra-data">
            <div class="extra-item"><div class="value"><span id="humidity">--</span>%</div><div class="label">Humidity</div></div>
            <div class="extra-item"><div class="value"><span id="observed-high">--</span>°</div><div class="label">24hr High</div></div>
            <div class="extra-item"><div class="value"><span id="observed-low">--</span>°</div><div class="label">24hr Low</div></div>
        </div>
        
        <div class="card short-forecast" id="short-forecast">Loading forecast...</div>
        <div class="update-footer" id="update-time">--</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        const CONFIG = {
            MESOWEST_STATION: 'E6393',
            MESOWEST_TOKEN: 'c651d1e209fa4443a42eeef956180701',
            STATION_LAT: 41.74,
            STATION_LON: -111.83,
            PURPLEAIR_SENSOR_ID: 3388,
            PURPLEAIR_API_KEY: 'AD6DCCEA-F17F-11F0-B596-4201AC1DC123',
            UPDATE_INTERVAL_WEATHER: 1 * 60 * 1000,
            UPDATE_INTERVAL_FORECAST: 1 * 60 * 1000,
            UPDATE_INTERVAL_AQI: 20 * 60 * 1000,
        };

        let nwsGridInfo = null;
        let forecastChart;
        let pressureChart;
        let weekChart;
        let pressureHistory = { times: [], values: [] };

        function initForecastChart() {
            const ctx = document.getElementById('forecast-chart').getContext('2d');
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (°F)',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Precip %',
                            data: [],
                            borderColor: '#74b9ff',
                            backgroundColor: 'rgba(116, 185, 255, 0.3)',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 7,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 35
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            titleFont: { size: 20 },
                            bodyColor: '#fff',
                            bodyFont: { size: 18 },
                            displayColors: true,
                            callbacks: {
                                label: function(ctx) {
                                    if (ctx.datasetIndex === 0) return `Temp: ${ctx.parsed.y}°F`;
                                    return `Precip: ${ctx.parsed.y}%`;
                                }
                            }
                        },
                        datalabels: {
                            display: function(ctx) {
                                return ctx.datasetIndex === 0; // Only show labels for temperature
                            },
                            color: '#fff',
                            font: function(ctx) {
                                const width = ctx.chart.width;
                                return { size: Math.max(12, Math.min(26, width / 25)), weight: 700 };
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            formatter: function(value) {
                                return value + '°';
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: 'rgba(255,255,255,0.6)', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(24, width / 27)), weight: 500 };
                                },
                                maxRotation: 0 
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { 
                                display: true, 
                                text: 'Temperature °F', 
                                color: '#ff6b6b', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(22, width / 30)), weight: 600 };
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: { 
                                display: true, 
                                text: 'Precipitation %', 
                                color: '#74b9ff', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(12, Math.min(22, width / 30)), weight: 600 };
                                },
                                padding: 0 
                            },
                            grid: { drawOnChartArea: false },
                            ticks: { 
                                color: '#74b9ff', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(10, Math.min(20, width / 33)), weight: 500 };
                                },
                                stepSize: 25, 
                                padding: 20 
                            }
                        }
                    }
                }
            });
        }

        function initPressureChart() {
            const ctx = document.getElementById('pressure-chart').getContext('2d');
            pressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#74ebd5',
                        backgroundColor: 'rgba(116, 235, 213, 0.15)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            titleFont: { size: 14 },
                            bodyColor: '#74ebd5',
                            bodyFont: { size: 14 },
                            displayColors: false,
                            callbacks: {
                                label: function(ctx) {
                                    return `${ctx.parsed.y.toFixed(2)} inHg`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 12 }, maxTicksLimit: 6, maxRotation: 0 }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 12 }, callback: v => v.toFixed(2), count: 5 },
                            grace: '5%'
                        }
                    }
                }
            });
        }

        function initWeekChart() {
            const ctx = document.getElementById('week-chart').getContext('2d');
            weekChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'High',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 6,
                            pointHoverRadius: 9
                        },
                        {
                            label: 'Low',
                            data: [],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 6,
                            pointHoverRadius: 9
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 35,
                            right: 10,
                            left: 10,
                            bottom: -5
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            titleFont: { size: 20 },
                            bodyColor: '#fff',
                            bodyFont: { size: 18 },
                            displayColors: true,
                            callbacks: {
                                label: function(ctx) {
                                    return `${ctx.dataset.label}: ${ctx.parsed.y}°F`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: function(ctx) {
                                return ctx.datasetIndex === 0 ? '#ff6b6b' : '#4ecdc4';
                            },
                            font: function(ctx) {
                                const width = ctx.chart.width;
                                return { size: Math.max(9, Math.min(17, width / 38)), weight: 700 };
                            },
                            anchor: function(ctx) {
                                return ctx.datasetIndex === 0 ? 'end' : 'start';
                            },
                            align: function(ctx) {
                                return ctx.datasetIndex === 0 ? 'top' : 'bottom';
                            },
                            offset: 6,
                            formatter: function(value) {
                                return value + '°';
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: 'rgba(255,255,255,0.6)', 
                                font: function(ctx) {
                                    const width = ctx.chart.width;
                                    return { size: Math.max(9, Math.min(19, width / 35)), weight: 500 };
                                },
                                maxRotation: 0, 
                                padding: 50 
                            }
                        },
                        y: {
                            display: false,
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        function updateTempRingColor(temp) {
            const ring = document.getElementById('temp-ring');
            if (!ring || temp === null) return;
            
            let color;
            
            if (temp <= 32) {
                // 0-32F: White (flipped - white at 0, gray at 32)
                const ratio = Math.max(0, Math.min(1, temp / 32));
                const gray = Math.round(255 - (55 * ratio)); // 255 to 200
                color = `rgb(${gray}, ${gray}, ${gray})`;
            } else if (temp <= 45) {
                // 33-45F: Light Blue (gradient from lighter to darker)
                const ratio = (temp - 33) / 12;
                const r = Math.round(173 - (43 * ratio)); // 173 to 130
                const g = Math.round(216 - (16 * ratio)); // 216 to 200
                const b = Math.round(230 - (5 * ratio)); // 230 to 225
                color = `rgb(${r}, ${g}, ${b})`;
            } else if (temp <= 55) {
                // 45-55F: Dark Blue (darker at 55)
                const ratio = (temp - 45) / 10;
                const r = Math.round(130 - (110 * ratio)); // 130 to 20
                const g = Math.round(200 - (80 * ratio)); // 200 to 120
                const b = Math.round(225 - (45 * ratio)); // 225 to 180
                color = `rgb(${r}, ${g}, ${b})`;
            } else if (temp <= 65) {
                // 55-65F: Green (light green at 56, darker green at 65)
                const ratio = (temp - 55) / 10;
                const r = Math.round(144 - (110 * ratio)); // 144 to 34
                const g = Math.round(238 - (43 * ratio)); // 238 to 195
                const b = Math.round(144 - (110 * ratio)); // 144 to 34
                color = `rgb(${r}, ${g}, ${b})`;
            } else if (temp <= 75) {
                // 65-75F: Yellow
                const ratio = (temp - 65) / 10;
                const r = Math.round(255); // Keep at 255
                const g = Math.round(235 - (20 * ratio)); // 235 to 215
                const b = Math.round(59 - (59 * ratio)); // 59 to 0
                color = `rgb(${r}, ${g}, ${b})`;
            } else if (temp <= 85) {
                // 75-85F: Orange
                const ratio = (temp - 75) / 10;
                const r = Math.round(255); // Keep at 255
                const g = Math.round(165 - (65 * ratio)); // 165 to 100
                const b = Math.round(0); // Keep at 0
                color = `rgb(${r}, ${g}, ${b})`;
            } else {
                // 85-100F: Red
                const ratio = Math.min(1, (temp - 85) / 15);
                const r = Math.round(255); // Keep at 255
                const g = Math.round(100 - (100 * ratio)); // 100 to 0
                const b = Math.round(0); // Keep at 0
                color = `rgb(${r}, ${g}, ${b})`;
            }
            
            ring.setAttribute('stroke', color);
        }

        async function fetchMesoWestData() {
            const params = new URLSearchParams({
                stid: CONFIG.MESOWEST_STATION,
                token: CONFIG.MESOWEST_TOKEN,
                recent: 1440,
                vars: 'air_temp,wind_speed,wind_gust,wind_direction,relative_humidity,altimeter',
                units: 'english'
            });
            try {
                const response = await fetch(`https://api.synopticdata.com/v2/stations/timeseries?${params}`);
                const data = await response.json();
                if (data.STATION && data.STATION.length > 0) {
                    updateWeatherDisplay(data.STATION[0]);
                }
            } catch (error) { console.error('MesoWest fetch error:', error); }
        }

        function updateWeatherDisplay(station) {
            const obs = station.OBSERVATIONS;

            document.getElementById('temp-link').href = `https://mesowest.utah.edu/cgi-bin/droman/meso_base_dyn.cgi?stn=${CONFIG.MESOWEST_STATION}`;

            // Show when page fetched data, not when MesoWest recorded it
            document.getElementById('update-time').textContent = `Last updated: ${new Date().toLocaleString()}`;

            if (obs.air_temp_set_1) {
                const temps = obs.air_temp_set_1.filter(t => t !== null);
                if (temps.length) {
                    const currentTemp = Math.round(temps[temps.length - 1]);
                    document.getElementById('temp-now').textContent = currentTemp;
                    document.getElementById('observed-high').textContent = Math.round(Math.max(...temps));
                    document.getElementById('observed-low').textContent = Math.round(Math.min(...temps));
                    updateTempRingColor(currentTemp);
                }
            }

            if (obs.wind_speed_set_1) {
                const w = obs.wind_speed_set_1.filter(x => x !== null);
                if (w.length) document.getElementById('wind-speed').textContent = Math.round(w[w.length - 1]);
            }
            if (obs.wind_gust_set_1) {
                const g = obs.wind_gust_set_1.filter(x => x !== null);
                if (g.length) document.getElementById('wind-gust').textContent = Math.round(g[g.length - 1]);
            }
            if (obs.wind_direction_set_1) {
                const d = obs.wind_direction_set_1.filter(x => x !== null);
                if (d.length) {
                    document.getElementById('wind-arrow').style.transform = `rotate(${d[d.length-1]}deg)`;
                    document.getElementById('wind-dir').textContent = degreesToCardinal(d[d.length-1]);
                }
            }
            if (obs.relative_humidity_set_1) {
                const h = obs.relative_humidity_set_1.filter(x => x !== null);
                if (h.length) document.getElementById('humidity').textContent = Math.round(h[h.length - 1]);
            }

            const pressureField = obs.altimeter_set_1 || obs.pressure_set_1;
            if (pressureField && obs.date_time) {
                const validIndices = pressureField.map((v, i) => v !== null ? i : -1).filter(i => i >= 0);
                const p = validIndices.map(i => pressureField[i]);
                const times = validIndices.map(i => obs.date_time[i]);
                
                if (p.length) {
                    document.getElementById('pressure-now').textContent = p[p.length - 1].toFixed(2);
                    
                    // Update trend
                    if (p.length > 12) {
                        const diff = p[p.length - 1] - p[p.length - 13];
                        const el = document.getElementById('pressure-trend');
                        el.textContent = diff > 0.02 ? '↑' : diff < -0.02 ? '↓' : '→';
                        el.className = 'pressure-trend ' + (diff > 0.02 ? 'trend-up' : diff < -0.02 ? 'trend-down' : 'trend-stable');
                    }
                    
                    // Update pressure chart - sample every ~2 hours for cleaner display
                    const step = Math.max(1, Math.floor(p.length / 12));
                    const chartTimes = [];
                    const chartValues = [];
                    for (let i = 0; i < p.length; i += step) {
                        chartTimes.push(new Date(times[i]).toLocaleTimeString([], { hour: 'numeric' }));
                        chartValues.push(p[i]);
                    }
                    // Always include latest
                    if (chartTimes[chartTimes.length - 1] !== new Date(times[times.length - 1]).toLocaleTimeString([], { hour: 'numeric' })) {
                        chartTimes.push(new Date(times[times.length - 1]).toLocaleTimeString([], { hour: 'numeric' }));
                        chartValues.push(p[p.length - 1]);
                    }
                    
                    if (pressureChart) {
                        pressureChart.data.labels = chartTimes;
                        pressureChart.data.datasets[0].data = chartValues;
                        pressureChart.update('none');
                    }
                }
            }
        }

        function degreesToCardinal(deg) {
            const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            return dirs[Math.round(deg / 22.5) % 16];
        }

        async function fetchNWSForecast() {
            if (!nwsGridInfo) {
                try {
                    const r = await fetch(`https://api.weather.gov/points/${CONFIG.STATION_LAT},${CONFIG.STATION_LON}`, { headers: { 'User-Agent': 'WeatherStation/1.0' } });
                    const d = await r.json();
                    nwsGridInfo = {
                        forecastUrl: d.properties.forecast,
                        forecastHourlyUrl: d.properties.forecastHourly
                    };
                } catch (e) { console.error('NWS grid error:', e); return; }
            }

            // Fetch regular forecast for today's high/low
            try {
                const r = await fetch(nwsGridInfo.forecastUrl, { headers: { 'User-Agent': 'WeatherStation/1.0' } });
                const d = await r.json();
                if (d.properties?.periods) updateForecastDisplay(d.properties.periods);
            } catch (e) { console.error('NWS forecast error:', e); }

            // Fetch hourly forecast for the graph
            try {
                const r = await fetch(nwsGridInfo.forecastHourlyUrl, { headers: { 'User-Agent': 'WeatherStation/1.0' } });
                const d = await r.json();
                if (d.properties?.periods) updateForecastChart(d.properties.periods);
            } catch (e) { console.error('NWS hourly forecast error:', e); }
        }

        function updateForecastDisplay(periods) {
            let high = null, low = null, precip = 0, forecast = '';
            for (const p of periods) {
                if (p.isDaytime && high === null) {
                    high = p.temperature;
                    forecast = p.shortForecast;
                    if (p.probabilityOfPrecipitation?.value) precip = Math.max(precip, p.probabilityOfPrecipitation.value);
                }
                if (!p.isDaytime && low === null) {
                    low = p.temperature;
                    if (p.probabilityOfPrecipitation?.value) precip = Math.max(precip, p.probabilityOfPrecipitation.value);
                }
                if (high !== null && low !== null) break;
            }
            if (high !== null) document.getElementById('forecast-high').textContent = high;
            if (low !== null) document.getElementById('forecast-low').textContent = low;
            document.getElementById('precip-chance').textContent = precip;
            document.getElementById('short-forecast').textContent = forecast || 'Forecast unavailable';
            
            // Update 7-day forecast chart
            const dailyData = [];
            for (let i = 0; i < periods.length && dailyData.length < 7; i += 2) {
                const day = periods[i];
                const night = periods[i + 1];
                if (day && night) {
                    const date = new Date(day.startTime);
                    const dayName = date.toLocaleDateString([], { weekday: 'short' });
                    dailyData.push({
                        name: dayName,
                        high: day.isDaytime ? day.temperature : night.temperature,
                        low: night.isDaytime ? day.temperature : night.temperature
                    });
                }
            }
            
            if (dailyData.length > 0 && weekChart) {
                weekChart.data.labels = dailyData.map(d => d.name);
                weekChart.data.datasets[0].data = dailyData.map(d => d.high);
                weekChart.data.datasets[1].data = dailyData.map(d => d.low);
                weekChart.update('none');
            }
        }

        function updateForecastChart(periods) {
            // Get next 12 hours
            const next12 = periods.slice(0, 12);
            
            const labels = next12.map(p => {
                const time = new Date(p.startTime);
                return time.toLocaleTimeString([], { hour: 'numeric' });
            });
            
            const temps = next12.map(p => p.temperature);
            const precips = next12.map(p => p.probabilityOfPrecipitation?.value || 0);

            if (forecastChart) {
                forecastChart.data.labels = labels;
                forecastChart.data.datasets[0].data = temps;
                forecastChart.data.datasets[1].data = precips;
                forecastChart.update('none');
            }
        }

        async function fetchAQI() {
            try {
                const r = await fetch(`https://api.purpleair.com/v1/sensors/${CONFIG.PURPLEAIR_SENSOR_ID}?fields=pm2.5_10minute`, { headers: { 'X-API-Key': CONFIG.PURPLEAIR_API_KEY } });
                const d = await r.json();
                if (d.sensor && d.sensor.stats) {
                    const pm25 = d.sensor.stats['pm2.5_10minute'];
                    const aqi = pm25ToAQI(pm25);
                    updateAQIDisplay(aqi);
                }
            } catch (e) { console.error('PurpleAir error:', e); updateAQIDisplay(null, 'Error'); }
        }

        function pm25ToAQI(pm) {
            const bp = [[0,12,0,50],[12.1,35.4,51,100],[35.5,55.4,101,150],[55.5,150.4,151,200],[150.5,250.4,201,300],[250.5,350.4,301,400],[350.5,500.4,401,500]];
            for (const [pl,ph,al,ah] of bp) if (pm >= pl && pm <= ph) return Math.round((ah-al)/(ph-pl)*(pm-pl)+al);
            return 500;
        }

        function updateAQIDisplay(aqi, override = null) {
            const el = document.getElementById('aqi-value'), st = document.getElementById('aqi-status');
            if (aqi === null) { el.textContent = '--'; st.textContent = override || 'Unavailable'; st.className = 'aqi-status'; return; }
            el.textContent = aqi; st.className = 'aqi-status';
            const [status, cls] = aqi <= 50 ? ['Good','aqi-good'] : aqi <= 100 ? ['Moderate','aqi-moderate'] : aqi <= 150 ? ['Unhealthy for Sensitive Groups','aqi-sensitive'] : aqi <= 200 ? ['Unhealthy','aqi-unhealthy'] : aqi <= 300 ? ['Very Unhealthy','aqi-very-unhealthy'] : ['Hazardous','aqi-hazardous'];
            st.textContent = override || status; st.classList.add(cls);
        }

        function enableFullscreen() {
            document.addEventListener('dblclick', () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
                else document.exitFullscreen();
            });
        }

        async function init() {
            initForecastChart();
            initPressureChart();
            initWeekChart();
            enableFullscreen();
            await fetchMesoWestData();
            await fetchNWSForecast();
            await fetchAQI();
            setInterval(fetchMesoWestData, CONFIG.UPDATE_INTERVAL_WEATHER);
            setInterval(fetchNWSForecast, CONFIG.UPDATE_INTERVAL_FORECAST);
            setInterval(fetchAQI, CONFIG.UPDATE_INTERVAL_AQI);
            
            // Refresh data when page becomes visible again (Safari suspends timers)
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'visible') {
                    await fetchMesoWestData();
                    await fetchNWSForecast();
                    await fetchAQI();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
